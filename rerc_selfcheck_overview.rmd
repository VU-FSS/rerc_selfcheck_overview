---
title: "Self-check overview"
date: "`r Sys.Date()`"
author: "Koen Leuveld"
output: pdf_document
header-includes:
   - \usepackage{booktabs}
---

<!-- 
Self Check overview
Author: Koen Leuveld

This file compiles data from from the self check of VU-FSS Research Ethics 
Review Committee into an overview document.

The data is downloaded from qualtrics by rerc_selfcheck_qualtricsdownload.R and
processed using functions as defined rerc_selfcheck_analysis.R

-->


```{r, include=FALSE}
library(knitr)
library(kableExtra)
library(janitor)

#user defined variables:
start_date <- "2023-02-21" #2023-03-23
setwd("C:/Users/kld330/git/rerc_selfcheck_overview")
download_data <- F


#Download data to update CSV files used by RERC_analysis.r
if (download_data) {
	source("rerc_selfcheck_qualtricsdownload.R") 
}

#load helper functions
source("rerc_selfcheck_overview_helpers.r")



#laod and clean data
self_check_data <- 
    read_csv("data/self_check_all.csv") %>%
    fix_dates %>%
    add_column(Outcome = compute_outcome(.))%>%
    cleanup()
    
```

```{r , echo=FALSE, message = FALSE}
   
#full staff overview
self_check_data %>%
filter(Date > start_date) %>%
filter(Position == "Staff") %>%
select(Date,Name,Dept = Department,Position = Position_detailed,Project,Outcome) %>%
standard_kable(paste("Completed self checks by staff and PhD candidates 
						  since",start_date, sep=" ", collapse=NULL),
               longtable = T)  %>%
kable_styling(latex_options = "repeat_header") %>%
set_widths(c(2,2.5,1,1,4.5,1))


#student detailed summary
self_check_data %>%
filter(Date > start_date) %>%
filter(Position == "Student") %>%
tabyl(Department,Outcome) %>%
adorn_totals(where="col")  %>%
standard_kable(paste("Number of completed checks by students by department 
                    since",start_date, sep=" ", collapse=NULL)) %>%
row_spec(5,hline_after=TRUE)




#staff past year
self_check_data %>%
filter(Position == "Staff") %>%
crop_df(Month,14) %>%
tabyl(Month,Department)%>%
adorn_totals(where=c("row","col")) %>%
standard_kable(caption="Number of completed checks by staff and PhD candidates in the last 14 months") %>%
row_spec(14,hline_after=TRUE)


#students past year
self_check_data %>%
filter(Position == "Student") %>%
crop_df(Month,14) %>%
tabyl(Month,Department)%>%
adorn_totals(where=c("row","col")) %>%
standard_kable(caption="Number of completed checks by master students in the last 14 months") %>%
row_spec(14,hline_after=TRUE)



sep <- read_csv("annual_report/SEP_tabellen.csv") %>%
   rename(FTE =`Research Time`) %>%
   mutate(Year = as.character(Year))


gen_propcol <- function(data) {
   cols <- names(data)[2:length(names(data))]
   cols <- as_tibble(cols)

   tibble <- 
   separate_wider_delim(cols, cols=value,delim="_",names=c("col","year"))

   years <- unique(tibble$year)
   print(years)
   cols <- unique(tibble$col)
   print(cols)

   data[,paste(cols[1],years[1],sep="_")] / data[,paste(cols[2],years[1],sep="_")]

}


order_columns <- function(data) {
   years <- 
      data %>%
      names %>%
      as_tibble %>%
      slice(2:n()) %>%
      separate_wider_delim(cols=value,delim="_",names=c("col","year")) %>%
      select(year) %>%
      unique %>%
      as.vector

   print(years)
   relocate(data,ends_with(years),.after=last_col())
}

years <- 
   test %>%
   names %>%
   as_tibble %>%
   slice(2:n()) %>%
   separate_wider_delim(cols=value,delim="_",names=c("col","year")) %>%
   select(year) %>%
   unique %>%
   as.vector

self_check_data %>%
   filter(Position == "Staff") %>%
   crop_df(Year,4) %>%
   tabyl(Year,Department) %>%
   pivot_longer(cols = !Year,names_to="Department", values_to = "N") %>%
   inner_join(select(sep,Department,Year,FTE)) %>%
   compute_totals(Year) %>%
   mutate(prop = N/FTE) %>%
   pivot_wider(names_from = Year, values_from = c(N,FTE,prop))%>%
   order_columns


cols <- names(burp)[2:length(names(burp))]
cols <- as_tibble(cols)

separate_wider_delim(cols,cols=value,delim="_",names=c("col","year"))



```

\clearpage

```{r echo=FALSE, message = F}


#plot the number of self-checks by staff and students
self_check_data %>%
   collapse_df(Month,Position) %>%
   crop_df(Month,48) %>%
   ggplot(aes(x=Month, y=N, group=Position,color=Position,fill=Position)) +
      geom_line() +          
      geom_smooth(method="loess",formula = y ~ x,se=FALSE) +           
      theme(axis.text.x = element_text(angle = 90)) +
      ggtitle("Number of completed self-checks by staff and students") 

#staff data broken down by department
self_check_data %>%
   filter(Position == "Staff") %>%
   collapse_df(Quarter,Department) %>%
   crop_df(Quarter,16) %>%
   ggplot(aes(x=Quarter, y=N, group=Department,color=Department,fill=Department)) +
      geom_bar(stat="identity",color="black", position=position_dodge()) +          
      geom_smooth(method="loess",formula = y ~ x,se=FALSE) +           
      theme(axis.text.x = element_text(angle = 90)) +
      ggtitle("Number of completed self-checks by staff") 


```