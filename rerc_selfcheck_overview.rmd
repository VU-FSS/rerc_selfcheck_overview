---
title: "Self-check overview"
date: "`r Sys.Date()`"
author: "Koen Leuveld"
output: pdf_document
header-includes:
   - \usepackage{booktabs}
---

<!-- 
Self Check overview
Author: Koen Leuveld

This file compiles data from from the self check of VU-FSS Research Ethics 
Review Committee into an overview document.

The data is downloaded from qualtrics by rerc_selfcheck_qualtricsdownload.R and
processed using functions as defined rerc_selfcheck_analysis.R

-->


```{r, include=FALSE}
library(knitr)
library(kableExtra)

#user defined variables:
start_date <- "2023-01-23" #2023-02-21
setwd("C:/Users/kld330/git/rerc_selfcheck_overview")
download_data <- T


#Download data to update CSV files used by RERC_analysis.r
if (download_data) {
	source("rerc_selfcheck_qualtricsdownload.R") 
}

#load helper functions
source("rerc_selfcheck_overview_helpers.r")


#laod and clean data
self_check_data <- 
    read_csv("data/self_check_all.csv") %>%
    fix_dates %>%
    add_column(Outcome = compute_outcome(.))%>%
    cleanup()
    
```

```{r , echo=FALSE, message = FALSE}
   
#full staff overview
self_check_data %>%
filter(Date > start_date) %>%
filter(Position == "Staff") %>%
select(Date,Name,Dept = Department,Position = Position_detailed,Project,Outcome) %>%
standard_kable(paste("Completed self checks by staff and PhD candidates 
						  since",start_date, sep=" ", collapse=NULL),
               longtable = T)  %>%
kable_styling(latex_options = "repeat_header") %>%
set_widths(c(2,2.5,1,1,4.5,1))


#student detailed summary
self_check_data %>%
filter(Date > start_date) %>%
filter(Position == "Student") %>%
counts_table(rows = Department,
             cols = Outcome) %>%
standard_kable(paste("Number of completed checks by students by department 
						  since",start_date, sep=" ", collapse=NULL)) %>%
row_spec(5,hline_after=TRUE)


#staff past year
self_check_data %>%
filter(Position == "Staff") %>%
counts_table(rows=Month,
                cols = Department,
                num_rows=14) %>%
standard_kable(caption="Number of completed checks by staff and PhD candidates in the last 14 months") %>%
row_spec(14,hline_after=TRUE)

#students past year
self_check_data %>%
filter(Position == "Student") %>%
counts_table(rows=Month,
                cols = Department,
                num_rows=14) %>%
standard_kable(caption="Number of completed checks by master students in the last 14 months") %>%
row_spec(14,hline_after=TRUE)

```

\clearpage

```{r echo=FALSE, message = F}


#plot the number of self-checks by staff and students
self_check_data %>%
   collapse_df(Month,Position) %>%
   crop_df(Month,48) %>%
   ggplot(aes(x=Month, y=N, group=Position,color=Position,fill=Position)) +
      geom_line() +          
      geom_smooth(method="loess",formula = y ~ x,se=FALSE) +           
      theme(axis.text.x = element_text(angle = 90)) +
      ggtitle("Number of completed self-checks by staff and students") 

#staff data broken down by department
self_check_data %>%
   filter(Position == "Staff") %>%
   collapse_df(Quarter,Department) %>%
   crop_df(Quarter,16) %>%
   ggplot(aes(x=Quarter, y=N, group=Department,color=Department,fill=Department)) +
      geom_bar(stat="identity",color="black", position=position_dodge()) +          
      geom_smooth(method="loess",formula = y ~ x,se=FALSE) +           
      theme(axis.text.x = element_text(angle = 90)) +
      ggtitle("Number of completed self-checks by staff") 


```